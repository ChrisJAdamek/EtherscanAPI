<!DOCTYPE html>
<html>
  <head>
    <title>Etherscan API - Transaction List</title>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      #results {
        margin-top: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Etherscan API - Transaction List</h1>
    <label for="apiKey">Enter your Etherscan API Key:</label>
    <input type="text" id="apiKey" placeholder="Your API Key">
    <br>
    <label for="address">Enter Ethereum addresses (comma-separated):</label>
    <input type="text" id="address" placeholder="0xde0b295669a9fd93d5f28d9ec85e40f4cb697bae, 0x742d35Cc6634C0532925a3b844Bc454e4438f44e">
    <button id="fetchTransactions">Fetch Transactions</button>

    <div id="summary"></div>
    <div id="results"></div>

<script>
  document.getElementById('fetchTransactions').addEventListener('click', fetchTransactionsWithDelay);

  // Consolidate fetchTransactions and fetchTokenTransfers into a single function
  async function fetchTransactionsAndTransfers(address, action, apiKey) {
    const url = buildURL(action, address, apiKey);
    const response = await fetch(url);
    const data = await response.json();

    let type;
    if (action === 'txlist') {
      type = 'normal';
    } else if (action === 'txlistinternal') {
      type = 'internal';
    } else if (action === 'tokentx') {
      type = 'erc20';
    } else if (action === 'tokennfttx') {
      type = 'erc721';
    } else if (action === 'token1155tx') {
      type = 'erc1155';
    }

    return {
      transactions: data.result.map((tx) => ({ ...tx, type })),
      transactionCount: data.result.length,
    };
  }

	async function fetchTokenPrice(contractAddress, timestamp) {
	  try {
	    const url = `https://coins.llama.fi/prices/historical/${timestamp}/ethereum:${contractAddress}?searchWidth=6h`;
	    console.log(`Fetching token price with URL: ${url}`); // Added console.log to print the URL
	    const response = await fetch(url);
	    const data = await response.json();
	    
	    if (data && data.coins && data.coins[`ethereum:${contractAddress}`]) {
	      return data.coins[`ethereum:${contractAddress}`].price;
	    } else {
	      console.error(`Token price not found for contract address: ${contractAddress} and timestamp: ${timestamp}`);
	      return 'N/A';
	    }
	  } catch (error) {
	    console.error(`Error fetching token price for contract address: ${contractAddress} and timestamp: ${timestamp}`, error);
	    return 'N/A';
	  }
	}

  async function getAllTransactions(fetchFunction, addresses, action, apiKey) {
    const allTransactions = [];
    const addressTransactionCounts = {};

    for (const address of addresses) {
      const { transactions, transactionCount } = await fetchFunction(address, action, apiKey);
      allTransactions.push(...transactions);

      // Update the transaction count for the address
      if (addressTransactionCounts.hasOwnProperty(address)) {
        addressTransactionCounts[address] += transactionCount;
      } else {
        addressTransactionCounts[address] = transactionCount;
      }
    }

    return { allTransactions, addressTransactionCounts };
  }

  async function fetchTransactionsWithDelay() {
    const apiKey = document.getElementById('apiKey').value;
    const inputAddresses = document.getElementById('address').value;
    const addresses = inputAddresses.split(',').map(a => a.trim());

    const transactionTypes = [
      { action: 'txlist', fetchFunction: fetchTransactionsAndTransfers },
      { action: 'txlistinternal', fetchFunction: fetchTransactionsAndTransfers },
      { action: 'tokentx', fetchFunction: fetchTransactionsAndTransfers },
      { action: 'tokennfttx', fetchFunction: fetchTransactionsAndTransfers },
      { action: 'token1155tx', fetchFunction: fetchTransactionsAndTransfers },
    ];

    const allTransactions = [];
    const addressTransactionCounts = {};

    // Initialize addressTransactionCounts object with addresses as keys and 0 as values
    addresses.forEach(address => addressTransactionCounts[address] = 0);

    for (const transactionType of transactionTypes) {
      const { allTransactions: transactions, addressTransactionCounts: transactionCounts } = await getAllTransactions(transactionType.fetchFunction, addresses, transactionType.action, apiKey);

      // Update the addressTransactionCounts object with the number of transactions for each address
      for (const address in transactionCounts) {
        if (addressTransactionCounts.hasOwnProperty(address)) {
          addressTransactionCounts[address] += transactionCounts[address];
        }
      }
      allTransactions.push(...transactions);
      await new Promise(resolve => setTimeout(resolve, 1000));
    }

    displaySummary(addressTransactionCounts, allTransactions.length);
    await displayTransactions(allTransactions);
  }

  function buildURL(action, address, apiKey) {
    return `https://api.etherscan.io/api?module=account&action=${action}&address=${address}&startblock=0&endblock=latest&page=1&offset=10000&sort=asc&apikey=${apiKey}`;
  }
  function displaySummary(addressTransactionCounts, totalCount) {
    const summaryDiv = document.getElementById('summary');
    summaryDiv.innerHTML = '';

    let summaryText = `Total entries found: ${totalCount}<br>`;
    for (const address in addressTransactionCounts) {
      summaryText += `Entries found for ${address}: ${addressTransactionCounts[address]}<br>`;
    }
    summaryDiv.innerHTML = summaryText;
  }

  async function displayTransactions(transactions) {
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';

    transactions.sort((a, b) => parseInt(a.timeStamp) - parseInt(b.timeStamp));

    const table = document.createElement('table');
    table.innerHTML = `
      <tr>
        <th>Type</th>
        <th>Timestamp</th>
        <th>TX Hash</th>
        <th>Value</th>
        <th>Token Symbol</th>
        <th>Token Price</th>
        <th>From</th>
        <th>To</th>
        <th>Contract Address</th>
        <th>TX Fee (ETH)</th>
        <th>Token Name</th>
        <th>Gas Price (Gwei)</th>
        <th>TX Failed</th>
      </tr>
    `;

    for (const tx of transactions) {
      let tokenPrice = 'N/A';
      if (tx.type === 'erc20') {
        tokenPrice = await fetchTokenPrice(tx.contractAddress, tx.timeStamp);
      }

      const value = getValue(tx);
      const tokenSymbol = getTokenSymbol(tx);

      const transactionFee = ((parseInt(tx.gasPrice) * parseInt(tx.gasUsed)) / 1e18).toFixed(6);

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${tx.type}</td>
        <td>${new Date(tx.timeStamp * 1000).toLocaleString()}</td>
        <td>${tx.hash}</td>
        <td>${value}</td>
        <td>${tokenSymbol}</td>
        <td>${tokenPrice}</td>
        <td>${tx.from}</td>
        <td>${tx.to}</td>
        <td>${tx.contractAddress}</td>
        <td>${transactionFee}</td>
        <td>${tx.tokenName || 'N/A'}</td>
        <td>${(parseInt(tx.gasPrice) / 1e9).toFixed(6)}</td>
        <td>${tx.isError === '1' ? 'Yes' : 'No'}</td>
      `;
      table.appendChild(row);
    }

    resultsDiv.appendChild(table);
  }

  // Helper function to get value
  function getValue(tx) {
    let value;
    if (tx.type === 'normal' || tx.type === 'internal' || tx.type === 'erc20') {
      value = (parseInt(tx.value) / ((tx.type === 'erc20' && tx.tokenDecimal !== 'N/A') ? Math.pow(10, tx.tokenDecimal) : 1e18)).toFixed(6);
    } else if (tx.type === 'erc721') {
      value = 1;
    } else if (tx.type === 'erc1155') {
      value = tx.tokenValue;
    }
    return value;
  }

  // Helper function to get token symbol
  function getTokenSymbol(tx) {
    let tokenSymbol;
    if (tx.type === 'internal' || tx.type === 'normal') {
      tokenSymbol = 'ETH';
    } else if (tx.type === 'erc20' || tx.type === 'erc721' || tx.type === 'erc1155') {
      tokenSymbol = tx.tokenSymbol || 'N/A';
      if (tx.type === 'erc721' || tx.type === 'erc1155') {
        tokenSymbol += '-' + tx.tokenID;
      }
    }
    return tokenSymbol;
  }
</script>
  </body>
</html>

 
